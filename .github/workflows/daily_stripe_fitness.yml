name: Daily Stripe Fitness Data

on:
  schedule:
    - cron: "10 5 * * *"
  workflow_dispatch:
    inputs:
      run_date:
        description: "Optional run date (YYYY-MM-DD)"
        required: false
        type: string

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Validate YAML spec
        run: |
          python - << 'PY'
          import yaml
          with open("specs/fitness_app.yml", "r") as f:
              yaml.safe_load(f)
          print("fitness_app.yml OK")
          PY

      - name: Run Stripe generator
        env:
          STRIPE_API_KEY: ${{ secrets.STRIPE_API_KEY }}
          FITNESS_SPEC_PATH: specs/fitness_app.yml
          RUN_DATE: ${{ inputs.run_date }}
        run: |
          python scripts/daily_stripe_fitness.py
