name: Stripe - initial 6-month backfill (test clock)

on:
  workflow_dispatch: {}

concurrency:
  group: stripe-backfill
  cancel-in-progress: false

jobs:
  backfill:
    runs-on: ubuntu-latest

    env:
      PYTHONPATH: scripts
      STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
      STRIPE_TEST_PAYMENT_METHOD: pm_card_visa

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 00 - Create catalog (products & prices)
        run: python scripts/00_create_catalog.py

      - name: 01 - Create test clock (frozen ~6 months ago)
        run: python scripts/01_create_test_clock.py

      - name: 02 - Create customers under test clock
        run: python scripts/02_create_customers.py

      - name: 03 - Attach payment methods (default)
        run: python scripts/03_attach_payment_methods.py

      - name: 04 - Create subscriptions
        run: python scripts/04_create_subscriptions.py

      - name: 05 - Advance test clock 6 months (generate renewals)
        run: python scripts/05_advance_clock_months.py
