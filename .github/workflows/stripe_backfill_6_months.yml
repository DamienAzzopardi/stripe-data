name: Stripe - initial 6-month backfill (test clock)

on:
  workflow_dispatch: {}

concurrency:
  group: stripe-backfill
  cancel-in-progress: false

jobs:
  backfill:
    runs-on: ubuntu-latest

    env:
      PYTHONPATH: stripe/scripts
      DAH_STATE_DIR: stripe/state
      STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}

      # optional knobs
      STRIPE_TEST_PAYMENT_METHOD: pm_card_visa

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r stripe/scripts/requirements.txt

      - name: 00 - Create catalog (products & prices)
        run: python stripe/scripts/00_create_catalog.py

      - name: 01 - Create test clock (frozen 6 months ago)
        run: python stripe/scripts/01_create_test_clock.py

      - name: 02 - Create customers under test clock
        run: python stripe/scripts/02_create_customers.py

      - name: 03 - Attach payment methods (default)
        run: python stripe/scripts/03_attach_payment_methods.py

      - name: 04 - Create subscriptions
        run: python stripe/scripts/04_create_subscriptions.py

      - name: 05 - Advance test clock 6 months (generate renewals)
        run: python stripe/scripts/05_advance_clock_months.py

      - name: Upload state artifacts (for debugging)
        uses: actions/upload-artifact@v4
        with:
          name: stripe-backfill-state
          path: stripe/state/*
